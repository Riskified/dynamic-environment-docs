"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[387],{9348:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>d});var t=i(5893),s=i(1151);const a={sidebar_label:"Running Sample",sidebar_position:3},o="Running the Sample Application",r={id:"getting-started/running",title:"Running the Sample Application",description:"In this section of the tutorial, we will demonstrate the installation of a sample application and",source:"@site/docs/getting-started/running.md",sourceDirName:"getting-started",slug:"/getting-started/running",permalink:"/dynamic-environment-docs/next/getting-started/running",draft:!1,unlisted:!1,editUrl:"https://github.com/Riskified/dynamic-environment-docs/edit/main/docs/getting-started/running.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_label:"Running Sample",sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Installation",permalink:"/dynamic-environment-docs/next/getting-started/installation"},next:{title:"Technical Overview",permalink:"/dynamic-environment-docs/next/advanced/technical-overview"}},l={},d=[{value:"Installing the BookInfo Application",id:"installing-the-bookinfo-application",level:2},{value:"Testing the Colored Rating using Dynamic Environment",id:"testing-the-colored-rating-using-dynamic-environment",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"running-the-sample-application",children:"Running the Sample Application"}),"\n",(0,t.jsxs)(n.p,{children:["In this section of the tutorial, we will demonstrate the installation of a sample application and\nhow to create a dynamic environment to test a new version of a single service within the\napplication. The application we're using is a slightly modified clone of the ",(0,t.jsx)(n.em,{children:"BookInfo"})," application\nthat comes with ",(0,t.jsx)(n.em,{children:"Istio"}),". For more detailed information about Istio's BookInfo application, you can\nrefer to the ",(0,t.jsx)(n.a,{href:"https://istio.io/v1.17/docs/examples/bookinfo/",children:"application page"}),"."]}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.p,{children:["Before proceeding, ensure that you have followed the prerequisites outlined in the previous sections\nof this tutorial. You should have a functional Kubernetes cluster with the required dependencies,\nand ",(0,t.jsx)(n.em,{children:"Dynamic Environment"})," deployed."]})}),"\n",(0,t.jsx)(n.h2,{id:"installing-the-bookinfo-application",children:"Installing the BookInfo Application"}),"\n",(0,t.jsxs)(n.p,{children:["Begin by downloading the ",(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:i(7849).Z+"",children:"tutorial files"}),", extracting the\narchive, and then installing the ",(0,t.jsx)(n.code,{children:"bookinfo.yml"})," manifest using the following command:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f bookinfo.yml\n"})}),"\n",(0,t.jsxs)(n.p,{children:["This will create a BookInfo application running in the ",(0,t.jsx)(n.code,{children:"dynenv-tutorial"})," namespace. It consists of\nfour services:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"\u2713 ~ \u27a4 kubectl get -n dynenv-tutorial service\nNAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\ndetails       ClusterIP   10.96.243.70    <none>        9080/TCP   3m40s\nproductpage   ClusterIP   10.96.169.74    <none>        9080/TCP   3m39s\nratings       ClusterIP   10.96.215.213   <none>        9080/TCP   3m40s\nreviews       ClusterIP   10.96.106.203   <none>        9080/TCP   3m40s\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Additionally, note the configured routes within the ",(0,t.jsx)(n.em,{children:"reviews"})," virtual service (only a single route):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:'      \u2713 ~ \u27a4 kubectl get -n dynenv-tutorial vs reviews -o yaml\n      apiVersion: networking.istio.io/v1beta1\n      kind: VirtualService\n      metadata:\n          riskified.com/dynamic-environment: ""\n        name: reviews\n        namespace: dynenv-tutorial\n        [...]\n      spec:\n        hosts:\n        - reviews\n        http:\n        - route:\n          - destination:\n              host: reviews\n              subset: shared\n'})}),"\n",(0,t.jsxs)(n.p,{children:["You can access the ",(0,t.jsx)(n.code,{children:"productpage"})," service, for example, by creating a port-forward. Navigate to\nthe ",(0,t.jsx)(n.code,{children:"/productpage"})," URL (e.g., ",(0,t.jsx)(n.code,{children:"http://localhost:9080/productpage"}),"). You should see something similar\nto this:"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"default view",src:i(3350).Z+"",width:"1430",height:"520"})}),"\n",(0,t.jsx)(n.h2,{id:"testing-the-colored-rating-using-dynamic-environment",children:"Testing the Colored Rating using Dynamic Environment"}),"\n",(0,t.jsxs)(n.p,{children:["Now, let's say you've developed a feature like colored stars in the ratings element, and you want to\ntest it before making it available to all users. In this example, you've made updates to\nthe ",(0,t.jsx)(n.code,{children:"reviews"})," application and uploaded a Docker image to the registry. To test your application, you\ncan create a dynamic environment manifest. Here's the final manifest (also included in the\ndownloaded ",(0,t.jsx)(n.code,{children:"tutorial.zip"})," archive):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:"title=dynamicenv-bookinfo.yml",children:"---\napiVersion: riskified.com/v1alpha1\nkind: DynamicEnv\nmetadata:\n  name: dynamicenv-sample\nspec:\n  istioMatches:\n    - headers:\n        end-user:\n          exact: jason\n  subsets:\n    - name: reviews\n      namespace: dynenv-tutorial\n      image: docker.io/istio/examples-bookinfo-reviews-v3:1.16.2\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.p,{children:["You can find reference documentation for the ",(0,t.jsx)(n.code,{children:"DynamicEnv"})," Custom Resource Definition (\nCRD) ",(0,t.jsx)(n.a,{href:"/dynamic-environment-docs/next/references/crd",children:"here"}),"."]})}),"\n",(0,t.jsx)(n.p,{children:"A few notes about the manifest:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Namespace: The ",(0,t.jsx)(n.em,{children:"dynamic environment"})," custom resource is not limited to deployment in the same\nnamespace as the resources it manipulates. It can be deployed in any namespace."]}),"\n",(0,t.jsxs)(n.li,{children:["Match: For testing, we're matching against a header named ",(0,t.jsx)(n.code,{children:"end-user"})," with the exact value\nof ",(0,t.jsx)(n.code,{children:"jason"}),". In our application, you need to log in as ",(0,t.jsx)(n.code,{children:"jason"})," for this header to be created."]}),"\n",(0,t.jsxs)(n.li,{children:["Subset: In our case, we're replacing only a single subset identified by its ",(0,t.jsx)(n.em,{children:"deployment"})," name and\nnamespace. Please note that we're only changing the image."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"To apply this manifest, run the following command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f dynamicenv-bookinfo.yml\n"})}),"\n",(0,t.jsx)(n.p,{children:"Now, you can check the dynamic environment's status by running:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"\u2713 ~ \u27a4 kubectl get de dynamicenv-sample -o yaml\napiVersion: riskified.com/v1alpha1\nkind: DynamicEnv\nmetadata:\n  [...] # skipped\n  finalizers:\n  - DeleteDeployments\n  - DeleteDestinationRules\n  - CleanupVirtualServices\n  name: dynamicenv-sample\n  namespace: default\n  [...] # skipped\nspec:\n    [...] # skipped\nstatus:\n  state: ready\n  subsets-status:\n    dynamicenv-tutorial/reviews:\n      deployment:\n        name: reviews-default-dynamicenv-sample\n        namespace: dynenv-tutorial\n        status: running\n      destination-rule:\n        name: reviews-default-dynamicenv-sample\n        namespace: dynenv-tutorial\n        status: running\n      hash: [...]\n      virtual-services:\n      - name: reviews\n        namespace: dynenv-tutorial\n        status: running\n  totalCount: 1\n  totalReady: 1\n"})}),"\n",(0,t.jsx)(n.p,{children:"A few things to note about this status:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["In the ",(0,t.jsx)(n.code,{children:"status"})," section, you can see that the global ",(0,t.jsx)(n.code,{children:"state"})," is ",(0,t.jsx)(n.em,{children:"ready"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"For each subset, you can see all the elements that have been created or modified to configure the\nrouting. Any errors should also appear here."}),"\n",(0,t.jsx)(n.li,{children:"Finalizers are added, which will be used to restore the previous state upon deletion."}),"\n",(0,t.jsx)(n.li,{children:"For each subset, a new deployment, a new destination rule, and relevant virtual services are\ncreated or modified."}),"\n",(0,t.jsxs)(n.li,{children:["For more details about the status, you can refer to\nthe ",(0,t.jsx)(n.a,{href:"/dynamic-environment-docs/next/references/crd#dynamicenvstatus",children:"reference documentation"})," and the corresponding section\nin the ",(0,t.jsx)(n.a,{href:"/dynamic-environment-docs/next/advanced/technical-overview#status-explained",children:"technical overview"})," document."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Now, let's test our application. Refresh the product page. Nothing should change. Try logging in\nwith various usernames (no password is needed), and you should still see the black stars rating.\nHowever, if you log in as the user ",(0,t.jsx)(n.em,{children:"jason"}),", you should see something like this (notice the colored\nratings):"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"alternate version view",src:i(809).Z+"",width:"1440",height:"505"})}),"\n",(0,t.jsx)(n.p,{children:"Let's observe some of the changes:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Added deployments (the last deployment is the one created for the dynamic environment - its name\ncontains the name of the dynamic environment):"}),"\n",(0,t.jsx)(n.p,{children:"\u2713 ~ \u27a4 kubectl get -n dynenv-tutorial deploy\nNAME                                READY   UP-TO-DATE   AVAILABLE   AGE\ndetails                             1/1     1            1           73m\ndetails-worker                      1/1     1            1           73m\nproductpage                         1/1     1            1           73m\nratings                             1/1     1            1           73m\nreviews                             1/1     1            1           73m\nreviews-default-dynamicenv-sample   1/1     1            1           25m"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Added destination rules (following the same naming convention as the deployments):"}),"\n",(0,t.jsx)(n.p,{children:"\u2713 ~ \u27a4 kubectl get -n dynenv-tutorial dr\nNAME                                HOST          AGE\ndetails                             details       75m\nproductpage                         productpage   75m\nratings                             ratings       75m\nreviews                             reviews       75m\nreviews-default-dynamicenv-sample   reviews       27m"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"We modified the relevant virtual service and added a route based on the configured match (skipped\npart of the output). You can refer to the [reference documentation for virtual hosts][vh] for more\ndetails on manipulating virtual services."}),"\n",(0,t.jsx)(n.p,{children:"\u2713 ~ \u27a4 kubectl get -n dynenv-tutorial vs reviews -o yaml\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\nriskified.com/dynamic-environment: default/dynamicenv-sample\nname: reviews\nnamespace: dynenv-tutorial\nspec:\nhosts:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"reviews\nhttp:"}),"\n",(0,t.jsxs)(n.li,{children:["headers:\nresponse:\nset:\nx-dynamic-env: reviews-default-dynamicenv-sample\nmatch:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"headers:\nend-user:\nexact: jason\nname: dynamic-environment-default-dynamicenv-sample-reviews-95c3950f70\nroute:"}),"\n",(0,t.jsx)(n.li,{children:"destination:\nhost: reviews\nsubset: default-dynamicenv-sample"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["route:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"destination:\nhost: reviews\nsubset: shared"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Finally, you can delete the dynamic environment and verify that everything returns to its original\nstate."}),"\n",(0,t.jsx)(n.p,{children:"d  ]: ../advanced/technical-overview.md#how-virtual-services-are-handled"})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},7849:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/files/running-tutorial-aa43597b3953ee6bcbbb324919ec74dc.zip"},809:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/bookinfo-alternate-version-baa24951f576a8dcf34df3d120c40a60.png"},3350:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/bookinfo-shared-version-1193d0d5b121f0922dcd6e929723f404.png"},1151:(e,n,i)=>{i.d(n,{Z:()=>r,a:()=>o});var t=i(7294);const s={},a=t.createContext(s);function o(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);